{% extends 'layouts/master-nav.html' %}
{% load static %}

{% block title %}Courses{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'vendors/choices.js/choices.min.css' %}"/>
  <link rel="stylesheet" href="{% static 'vendors/toastify/toastify.css' %}"/>
{% endblock %}

{% block content %}
  <div class="page-heading">
    <div class="page-title">
      <div class="row">
        <div class="col-12 col-md-12 order-md-1 order-last">
          <h2>{{ course }}</h2>
          <p class="text-subtitle text-muted">Course details</p>
        </div>
      </div>
    </div>

    <!-- Course information card -->
    <div class="row">
      <div class="col-12 m-2">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title ">Course Information</h4>
            {# edit details button #}
            {% if course.owner == request.user %}
              <a class="btn btn-sm btn-danger" href="{% url 'update-course' course_id=course.id %}?next={{ request.path }}">Edit Details</a>
            {% endif %}
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-4">
                <h6>Course Code</h6>
                <p>{{ course.code }}</p>
              </div>
              <div class="col-4">
                <h6>Course Name</h6>
                <p>{{ course.name }}</p>
              </div>
              <div class="col-4">
                <h6>Course Owner</h6>
                <p>{{ course.owner.username }} ({{ course.owner.name }})</p>
              </div>
            </div>
            <div class="row">
              <div class="col-4">
                <h6>Academic Year</h6>
                <p>{{ course.year }}</p>
              </div>
              <div class="col-4">
                <h6>Semester</h6>
                <p>{{ course.get_semester_display }}</p>
              </div>
              <div class="col-4">
                <h6>Students</h6>
                <p><span id="students_count">{{ course.students.count }}</span> students enrolled</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Students and Maintainers row -->
    <div class="row">

      <!-- Student cards -->
      <div class="col-8">
        <div class="card-group">

          <!-- View/remove students card -->
          <div class="card">
            <div class="card-content">
              <div class="card-body">
                <h4 class="card-title">View / Remove Students</h4>
                <p class="card-text">
                  View a list of enrolled students, or select students to remove from the course using the dropdown below.
                </p>
                <div class="alert alert-success" id="remove-student-alert" style="display:none;"></div>
                <form id="remove-student-form">
                  <!-- Students picker -->
                  <label for="student-picker"><b>Enrolled Students</b></label>
                  <select multiple class="form-group" id="student-picker" name="students"></select>

                  <!-- Remove button -->
                  <div class="col-12 d-flex justify-content-end">
                    <button class="btn btn-danger">Remove selected</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Add students card -->
          <div class="card">
            <div class="card-content">
              <div class="card-body">
                <h4 class="card-title">Add Students</h4>
                <p class="card-text">
                  Enter a list of usernames to add to the course!
                </p>
                <div class="alert alert-success" id="add-students-alert" style="display:none;"></div>
                <form id="add-students-form">
                  <!-- Usernames input -->
                  <div class="form-group mb-3">
                    <label for="id_student-usernames" class="form-label"><b>Usernames (one per line)</b></label>
                    <textarea class="form-control" id="id_student-usernames" rows="5" spellcheck="false" style="text-transform: uppercase"
                              required></textarea>
                  </div>

                  <!-- Add button -->
                  <div class="col-12 d-flex justify-content-end">
                    <button class="btn btn-success" id="addStudentsBtn">Add</button>
                  </div>
                </form>

                <!-- Add students log -->
                <div id="add-students-log-div" style="display:none;">
                  <hr>
                  <label for="ignored-usernames"><b>Ignored usernames</b></label>
                  <p>The following lines were ignored as accounts with these usernames do not exist.</p>
                  <textarea class="form-control" id="ignored-usernames" disabled>
                  </textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Maintainers card -->
      <div class="col-4">
        <div class="card">
          <div class="card-content">
            <div class="card-body">
              <h4 class="card-title">Maintainers</h4>
              <p class="card-text">
                Maintainers <b>can add and remove students</b> from the course.
              </p>
              <div class="alert alert-success" id="remove-student-alert" style="display:none;"></div>
              <form id="remove-student-form">
                <!-- Maintainers picker -->
                <label for="maintainers-picker"><b>Current Maintainers</b></label>
                <div class="spinner-border spinner-border-sm" id="maintainer-loading" style="display:none"></div>
                <select multiple class="form-group" id="maintainers-picker" name="maintainers"
                        {% if course.owner != request.user %} disabled {% endif %}></select>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src="{% static 'vendors/jquery/jquery.min.js' %}"></script>
  <script src="{% static 'vendors/choices.js/choices.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'vendors/toastify/toastify.js' %}"></script>

  <!-- Student selector script -->
  <script>
      const studentPicker = document.getElementById("student-picker");
      let students_arr = [
          {% for user in course.students.all %}
              {value: '{{ user.id }}', label: '{{ user.username }} ({{ user.name }})', selected: false},
          {% endfor %}
      ]
      let choice1 = new Choices(studentPicker, {
          removeItemButton: true,
          choices: students_arr
      });
  </script>

  <!-- Maintainers selector script -->
  <script>
      const maintainerLoading = $("#maintainer-loading");
      const maintainersPicker = document.getElementById("maintainers-picker");
      let maintainers_arr = [
          {% for user in staff %}
              {
                  value: '{{ user.id }}',
                  label: '{{ user.username }} ({{ user.name }})',
                  selected: {% if user in course.maintainers.all %} true {% else %} false {% endif %}
              },
          {% endfor %}
      ]
      let choice2 = new Choices(maintainersPicker, {
          removeItemButton: true,
          choices: maintainers_arr,
      });

      // when user adds a new maintainer
      maintainersPicker.addEventListener("addItem", (event) => {
          maintainerLoading.show();
          choice2.disable();

          // prepare data
          let formData = new FormData();
          formData.append("maintainer_id", event.detail.value);
          formData.append("action", "add");
          formData.append("course_id", "{{ course.id }}");
          formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

          // ajax request
          $.ajax({
              type: 'POST',
              url: "{% url 'update-course-maintainer' %}",
              data: formData,
              processData: false,
              contentType: false,
          }).done((res) => {
              setTimeout(() => {
                  if (res.result === "success")
                      Toastify({
                          text: "The maintainer has been added successfully!",
                          duration: 2000,
                          position: "center",
                          style: {"background": "#77DD77"}
                      }).showToast();
                  else {
                      Toastify({
                          text: "Unable to add maintainer to course! Please refresh the page.",
                          duration: 5000,
                          position: "center",
                          style: {"background": "#ff6961"}
                      }).showToast();
                  }
              }, 300);
          }).fail((res) => {
              Toastify({
                  text: "An error has occurred while adding the maintainer. Please refresh the page.",
                  duration: 5000,
                  position: "center",
                  style: {"background": "#ff6961"}
              }).showToast();
          }).always((res) => {
              setTimeout(() => {
                  choice2.enable();
                  maintainerLoading.hide();
              }, 300)
          });
      })

      // when user removes a maintainer
      maintainersPicker.addEventListener("removeItem", (event) => {
          choice2.disable();
          maintainerLoading.show();

          // prepare data
          let formData = new FormData();
          formData.append("maintainer_id", event.detail.value);
          formData.append("action", "remove");
          formData.append("course_id", "{{ course.id }}");
          formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

          // ajax request
          $.ajax({
              type: 'POST',
              url: "{% url 'update-course-maintainer' %}",
              data: formData,
              processData: false,
              contentType: false,
          }).done((res) => {
              setTimeout(() => {
                  if (res.result === "success")
                      Toastify({
                          text: "The maintainer has been removed successfully!",
                          duration: 2000,
                          position: "center",
                          style: {"background": "#77DD77"}
                      }).showToast();
                  else {
                      Toastify({
                          text: "Unable to remove maintainer from the course! Please refresh the page.",
                          duration: 5000,
                          position: "center",
                          style: {"background": "#ff6961"}
                      }).showToast();
                  }
              }, 300);
          }).fail((res) => {
              Toastify({
                  text: "An error has occurred while removing the maintainer. Please refresh the page.",
                  duration: 5000,
                  position: "center",
                  style: {"background": "#ff6961"}
              }).showToast();
          }).always((res) => {
              setTimeout(() => {
                  choice2.enable();
                  maintainerLoading.hide();
              }, 300);
          });
      })

  </script>

  <!-- Function to refresh enrolled students -->
  <script>
      // requests students list from api, clears and updates dropdown choices, updates enrolled count
      function updateStudentsList() {
          $.ajax({
              type: 'GET',
              url: "{% url 'get-course-students' %}?course_id={{ course.id }}",
              processData: false,
              contentType: false,
          }).done((res) => {
              if (res.result === "success") {
                  // update students_arr
                  students_arr = res.students.map(student => {
                      return {
                          value: student.id,
                          label: `${student.username} (${student.last_name} ${student.first_name})`,
                          select: false,
                      }
                  });

                  // update students dropdown
                  choice1.removeActiveItems(); // clear selection
                  choice1.clearChoices(); // remove all choices
                  choice1.setChoices(students_arr); // set new choices

                  // update enrolled count
                  $("#students_count").html(students_arr.length);
              } else {
                  Toastify({
                      text: "An error has occurred while refreshing the students list.",
                      duration: 5000,
                      position: "center",
                      style: {"background": "#ff6961"}
                  }).showToast();
              }
          }).fail((res) => {
              Toastify({
                  text: "An error has occurred while refreshing the students list. Please refresh the page.",
                  duration: 5000,
                  position: "center",
                  style: {"background": "#ff6961"}
              }).showToast();
          }).always((res) => {
          });
      }
  </script>

  <!-- Remove students form -->
  <script>
      const removeStudentsForm = document.getElementById("remove-student-form");
      const removeStudentAlert = $("#remove-student-alert");

      removeStudentsForm.onsubmit = function (event) {
          event.preventDefault();

          // hide and reset elements
          removeStudentAlert.hide();
          removeStudentAlert.removeClass("alert-success");
          removeStudentAlert.removeClass("alert-danger");

          // get selected students
          let selectedStudents = choice1.getValue(true);

          if (selectedStudents.length === 0) {
              removeStudentAlert.addClass("alert-danger");
              removeStudentAlert.text("No students selected!");
              removeStudentAlert.show();
          } else {
              // create form data
              let formData = new FormData();
              formData.append("student_ids", selectedStudents);
              formData.append("course_id", "{{ course.id }}");
              formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

              // ajax request
              $.ajax({
                  type: 'POST',
                  url: "{% url 'remove-students-from-course' %}",
                  data: formData,
                  processData: false,
                  contentType: false,
              }).done((res) => {
                  // set alert message and show
                  removeStudentAlert.text(res.msg);
                  removeStudentAlert.show();

                  // set correct alert class
                  if (res.result === "error") { //error
                      removeStudentAlert.addClass("alert-danger");
                  } else {
                      removeStudentAlert.addClass("alert-success");

                      // update students
                      updateStudentsList();
                  }
              }).fail((res) => {
                  removeStudentAlert.addClass("alert-danger");
                  removeStudentAlert.html("Something went wrong with your request! 😰");
                  removeStudentAlert.show();
              }).always((res) => {
              });
          }

          return false;
      }
  </script>

  <!-- Add students form -->
  <script>
      const addStudentsForm = document.getElementById("add-students-form");
      const addStudentsBtn = document.getElementById("addStudentsBtn");
      const usernamesTextArea = $("#id_student-usernames");
      const addStudentsAlert = $("#add-students-alert");
      const addStudentsLogDiv = $("#add-students-log-div");
      const ignoredUsernames = $("#ignored-usernames");

      addStudentsForm.onsubmit = function (event) {
          event.preventDefault();

          // hide and reset elements
          addStudentsAlert.hide();
          addStudentsAlert.removeClass("alert-success");
          addStudentsAlert.removeClass("alert-danger");
          addStudentsLogDiv.hide();

          //disable add button
          addStudentsBtn.innerText = 'Processing...';
          addStudentsBtn.disabled = true;

          // prepare form data
          let formData = new FormData();
          formData.append("usernames", usernamesTextArea.val());
          formData.append("course_id", "{{ course.id }}");
          formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

          $.ajax({
              type: 'POST',
              url: "{% url 'add-students-to-course' %}",
              data: formData,
              processData: false,
              contentType: false,
          }).done((res) => {
              // set alert message and show
              addStudentsAlert.text(res.msg);
              addStudentsAlert.show();

              // set correct alert class
              if (res.result === "error") { //error
                  addStudentsAlert.addClass("alert-danger");
              } else { //success
                  addStudentsAlert.addClass("alert-success");
                  usernamesTextArea.val('');

                  // if any of the usernames provided were not found, display them
                  if (res.not_found.length !== 0) {
                      ignoredUsernames.html(res.not_found.join('\n'));
                      addStudentsLogDiv.show();
                  }

                  // update students
                  updateStudentsList();
              }
          }).fail((res) => {
              addStudentsAlert.addClass("alert-danger");
              addStudentsAlert.html("Something went wrong with your request! 😰");
              addStudentsAlert.show();
          }).always((res) => {
              // reset form
              addStudentsBtn.innerText = 'Add';
              addStudentsBtn.disabled = false;
          })
      }
  </script>



{% endblock %}
