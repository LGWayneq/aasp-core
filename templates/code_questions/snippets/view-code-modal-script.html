{% load static %}
<!-- View question script -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script type="text/javascript" src="{% static 'vendors/highlight.js/highlight.min.js' %}"></script>
{% include 'includes/js/mathjax.html' %}


<script>
    marked.setOptions({
        breaks: true
    })

    const codeModalLoading = $("#code-modal-loading");
    const codeModalBody = $("#code-modal-body");

    const cqName = $("#cq-name");
    const cqDescription = $("#cq-description");
    const cqTestCases = $("#cq-test-cases");
    const cqLanguages = $("#cq-languages");
    const cqConcurrency = $("#cq-concurrency");
    const cqSolutionCode = $("#cq-solution-code");

    const viewCodeModal = (btn) => {
        // clear old data
        cqTestCases.empty();
        cqName.html("");
        cqDescription.html("");
        cqLanguages.html("");
        cqConcurrency.html("");
        cqSolutionCode.html("");

        // get code question id
        const cq_id = $(btn).data('cq-id');

        // show code-modal-loading, hide code-modal-body
        codeModalBody.hide();
        codeModalLoading.show();

        // ajax request
        $.ajax({
            type: 'GET',
            url: "{% url 'get-code-question-details' %}",
            data: {cq_id},
        }).done((res, textStatus, jqXHR) => {
            if (res.result === "success") {
                let rows = "";
                res.code_question.testcase_set.forEach((val, idx) => {
                    rows += `<tr><td>${idx + 1}</td><td>${val.score}</td><td><a href="{% url 'export-test-case-stdin' %}?test_case_id=${val.id}">Input file</a></td><td><a href="{% url 'export-test-case-stdout' %}?test_case_id=${val.id}">Output file</a></td><td>${val.time_limit}</td><td>${val.memory_limit}</td></tr>`
                })

                let languages = "";
                res.code_question.languages.forEach((val, idx) => {
                    languages += `<span class="badge bg-light-secondary me-1">${val.name}</span>`
                })

                // set values
                cqName.html(res.code_question.name)
                cqDescription.html(marked.parse(res.code_question.description));
                cqTestCases.append(rows);
                cqLanguages.html(languages);
                cqConcurrency.html(res.code_question.is_concurrency_question ? "True" : "False");
                cqSolutionCode.html(res.code_question.solution_code);
                hljs.highlightAll();

                // render math
                MathJax.typeset();

                setTimeout(() => {
                    codeModalLoading.hide();
                    codeModalBody.show();
                }, 500);
            }
        }).fail((jqXHR, textStatus, errorThrown) => {
            // 4xx status codes
            if (Math.floor(jqXHR.status / 100) == 4) {
                console.error("Internal Error!");
            }
            else {
                console.error("External API Error!");
            }
        });

        // show modal
        $('#codeDetailsModal').modal('show');
    };
</script>
