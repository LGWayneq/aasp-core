<div class="d-flex justify-content-between">
    <div>
        {% if is_software_language %}
        <button type="button" id="sample-btn" class="btn btn-warning" onclick="compileAndRun()">Compile and
            Run<i class="fa-solid fa-play ms-2"></i></button>
        {% else %}
        <button type="button" id="sample-btn" class="btn btn-warning" onclick="compileAndRun()">Compile<i
                class="fa-solid fa-play ms-2"></i></button>
        <button type="button" id="waveform-btn" class="btn btn-info d-none" onclick="viewWaveform()">Run</button>
        {% endif %}
        <button type="button" id="submit-btn" onclick="submit();" class="btn btn-success">Submit</button>
    </div>
    <div>
        <span class="h5" id="run-status">Ready</span>
        <div class="spinner-border spinner-border-sm ms-2" id="main-loading" style="display:none;"></div>
        <br>
        <button type="button" id="more-details" class="btn btn-link p-0 view-modal" onclick="viewModal(this)"
            style="display:none;">
            More Details
        </button>
    </div>
</div>

<script>
    // "compile and run" clicked
    const compileAndRun = () => {
        // disable buttons
        sampleBtn.prop("disabled", true);
        submitBtn.prop("disabled", true);

        // hide more details link
        mainLoading.show();
        moreDetails.hide();
        runStatus.html('Submitting');

        // prepare form data
        let formData = new FormData();
        formData.append("code", editor.getValue());
        formData.append("lang-id", langSelect.find("option:selected").data('judgeid'));
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        // ajax call
        $.ajax({
            type: 'POST',
            url: "{% url 'submit-single-test-case' test_case_id=sample_tc.id %}",
            data: formData,
            processData: false,
            contentType: false,
        }).done((res, textStatus, jqXHR) => {
            if (res.result === "success") {
                const token = res.token;
                updateSampleStatus(token);
            }
        }).fail((jqXHR, textStatus, errorThrown) => {
            window.setTimeout(() => {
                // 4xx status codes
                if (Math.floor(jqXHR.status / 100) == 4) {
                    console.error('Internal API error!');
                    showError("Internal API Error &#x274C;");
                }
                else {
                    console.error('External API error!');
                    showError("External API Error &#x274C;");
                }
            }, 1000);
        });
    };

    const viewWaveform = () => {
        const vcd = waveformBtn.data('vcd');
        if (!vcd) {
            showErrorToast("An error has occurred. Please check that you have successfully compiled your code and try again.");
            return;
        }

        // disable buttons
        sampleBtn.prop("disabled", true);
        submitBtn.prop("disabled", true);

        $.ajax({
            type: 'POST',
            url: "{% url 'vcdrom' %}",
            data: { vcd: vcd, csrfmiddlewaretoken: "{{ csrf_token }}" },
        }).done((res, textStatus, jqXHR) => {
            var iframeDocument = modalIframe.contentDocument || modalIframe.contentWindow.document;
            iframeDocument.open();
            iframeDocument.write(res);
            iframeDocument.close();
            vcdromModal.modal('show');
        }).fail((jqXHR, textStatus, errorThrown) => {
            // 4xx status codes
            if (Math.floor(jqXHR.status / 100) == 4) {
                console.error("Internal API Error!");
                showError("Internal API Error &#x274C;");
            }
            else {
                console.error("External API Error!");
                showError("External API Error &#x274C;");
            }
        });

        // enable buttons when modal close
        vcdromModal.on('hidden.bs.modal', () => {
            sampleBtn.prop("disabled", false);
            submitBtn.prop("disabled", false);
        });
    }

    // "More Details" or "Test Case x" clicked (opens modal)
    const viewModal = (btn) => {
        // get token
        const token = $(btn).data('token');

        // show m-loading, hide m-body
        modalBody.hide();
        modalLoading.show();

        // hide waveforms
        modalTiming.addClass("d-none")
        modalAccordion.addClass("d-none")
        modalHidden.addClass("d-none")
        modalError.addClass("d-none")

        // ajax request
        $.ajax({
            type: 'GET',
            url: "{% url 'get-tc-details' %}",
            data: { token, status_only: false },
        }).done((res, textStatus, jqXHR) => {
            if (res.result === "success") {
                // set values
                modalToken.html(token);
                modalStdin.html(res.data.stdin ? res.data.stdin : '&nbsp;');
                modalOutcome.html(res.data.status);

                if ('{{ is_software_language }}' === 'True') {
                    modalStdout.html(res.data.stdout ? res.data.stdout : '&nbsp;');
                    modalExpectedOutput.html(res.data.expected_output ? res.data.expected_output : '&nbsp;');
                } else {
                    if (res.data.stdout && res.data.stdout !== 'Hidden') {
                        // show waveforms
                        modalAccordion.removeClass("d-none")

                        const wavedromGroups = compareWaveform(res.data.expected_output, res.data.stdout)

                        wavedromGroups.forEach((wavedrom, index) => {
                            // update accordion header
                            const accordionHeader = document.getElementById(`waveformHeading${index + 1}`);
                            const accordionButton = accordionHeader.querySelector('.accordion-button');
                            let title

                            if (wavedrom.signal[6].wave.includes('h'))
                                title = `${wavedrom.signal[2][1].name}<span style="margin-left: 30px">&#x274C;</span>`
                            else
                                title = `${wavedrom.signal[2][1].name}<span style="margin-left: 30px">&#x2705;</span>`

                            accordionButton.innerHTML = title;

                            // update waveform
                            const modalWavedrom = document.getElementById(`InputJSON_${index + 1}`)
                            modalWavedrom.innerHTML = JSON.stringify(wavedrom)
                            WaveDrom.RenderWaveForm(index + 1, WaveDrom.eva(`InputJSON_${index + 1}`), "WaveDrom_Display_")
                        })
                    } else if (res.data.stdout === 'Hidden') {
                        // show hidden
                        modalTiming.addClass("d-none")
                        modalHidden.removeClass("d-none")
                    } else if (res.data.status_id === 6) {  // compilation error
                        // hide timing diagram
                        modalTiming.addClass("d-none")

                        // show error message
                        modalError.removeClass("d-none")
                        modalErrorMsg.html(res.data.compile_output)
                    } else {
                        // show error message
                        modalError.removeClass("d-none")
                        modalErrorMsg.html(res.data.stderr)
                    }
                }

                setTimeout(() => {
                    modalLoading.hide();
                    modalBody.show();
                }, 500);
            }
        }).fail((jqXHR, textStatus, errorThrown) => {
            // 4xx status codes
            if (Math.floor(jqXHR.status / 100) == 4) {
                console.error("Internal API Error!");
            }
            else {
                console.error("External API Error!");
            }
        });

        // show modal
        $('#detailsModal').modal('show');
    };

    // submit code, create new submission
    const submit = () => {
        // disable buttons
        sampleBtn.prop("disabled", true);
        submitBtn.prop("disabled", true);

        // hide more details link
        mainLoading.show();
        moreDetails.hide();
        runStatus.html('Submitting');

        // prepare form data
        let formData = new FormData();
        formData.append("code", editor.getValue());
        formData.append("lang-id", langSelect.find("option:selected").data('judgeid'));
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        // ajax call
        $.ajax({
            type: 'POST',
            url: "{% url 'code-question-submission' code_question_attempt_id=question_attempt.id %}",
            data: formData,
            processData: false,
            contentType: false,
        }).done((res, textStatus, jqXHR) => {
            if (res.result === "success") {
                setTimeout(() => {
                    // update status
                    runStatus.html('Processing');

                    // add accordion
                    const clonedAccordionItem = $("#accordion-item-template").clone();
                    clonedAccordionItem.removeAttr('id style');
                    clonedAccordionItem.html(
                        $(clonedAccordionItem).html().replaceAll('__cqs_id__', res.cqs_id).replaceAll('__time_submitted__', res.time_submitted)
                    );

                    res.statuses.forEach((value, idx) => {
                        const clonedTestCase = $("#test-case-template").clone();
                        clonedTestCase.removeAttr('id style');
                        clonedTestCase.html(
                            $(clonedTestCase).html().replaceAll('__tca_id__', value[0]).replaceAll('__idx__', idx + 1).replaceAll('__token__', value[2])
                        );
                        clonedAccordionItem.find(`#submission-${res.cqs_id} > div > div`).append(clonedTestCase);
                    });
                    $("#submissions-accordion").prepend(clonedAccordionItem);
                    $("#submission-" + res.cqs_id).collapse('show');
                    // call updator function
                    updateSubmissionStatus(res.cqs_id);
                }, 500);
            }
        }).fail((jqXHR, textStatus, errorThrown) => {
            // 4xx status codes
            if (Math.floor(jqXHR.status / 100) == 4) {
                console.error("Internal API Error!");
                showError("Internal API Error &#x274C;");
            }
        })
    };

    // "view waveform" clicked
    const compareWaveform = (expectedWave, studentWave) => {
        const expectedSignals = JSON.parse(expectedWave).signal
        const studentSignals = JSON.parse(studentWave).signal

        const expectedOutput = expectedSignals.filter((signal) => signal.name.startsWith('out_'))
        const studentOutput = studentSignals.filter((signal) => signal.name.startsWith('out_'))

        const waveformGroups = []

        // Generate mismatch signal
        expectedOutput.forEach((signal, index) => {
            const mismatch = generateMismatch(expectedOutput[index], studentOutput[index])
            const groupedSignals = { signal: [['Input'], {}, ['Yours'], {}, ['Ref'], {}, { 'name': 'Mismatch', 'wave': '' }], foot: { tick: 0, every: 5 } }
            groupedSignals.signal[6]['wave'] = mismatch
            waveformGroups.push(groupedSignals)
        })

        expectedOutput.forEach((signal, index) => {
            signal.name = signal.name.replace(/^(out_)/, '');
            waveformGroups[index].signal[4].push(signal);
        })

        // Group signals by input and output
        expectedSignals.forEach((signal) => {
            const direction = signal.name.startsWith('in_') ? 'Input' : 'Yours';
            signal.name = signal.name.replace(/^(in_|out_)/, '');

            if (direction === 'Input') {
                // Push to every waveform group
                waveformGroups.forEach((group) => {
                    group.signal[0].push(signal)
                })
            }
        })

        studentOutput.forEach((signal, index) => {
            signal.name = signal.name.replace(/^(out_)/, '');
            waveformGroups[index].signal[2].push(signal)
        })

        return waveformGroups
    }

    const generateMismatch = (expectedOutput, studentOutput) => {
        // compare the two outputs
        const expectedWave = expectedOutput.wave
        const studentWave = studentOutput.wave
        const expectedData = expectedOutput.data
        const studentData = studentOutput.data

        const mismatch = { 'name': 'Mismatch' }
        let mismatchWave = ''
        let counter = 0 // counter to track data index
        let currentMismatch = 'low'

        let expectedArr = []
        let studentArr = []

        // convert all '.' to previous value
        expectedWave.split('').forEach((char, index) => {
            if (char === '.') {
                expectedArr.push(expectedArr[index - 1])
            } else if (char === '=') {
                expectedArr.push(expectedData[counter])
                counter++
            } else {
                expectedArr.push(char)
            }
        })

        counter = 0

        studentWave.split('').forEach((char, index) => {
            if (char === '.') {
                studentArr.push(studentArr[index - 1])
            } else if (char === '=') {
                studentArr.push(studentData[counter])
                counter++
            } else {
                studentArr.push(char)
            }
        })

        // compare the two strings to generate mismatch
        for (let i = 0; i < expectedArr.length; i++) {
            if (expectedArr[i] === 'x' || studentArr[i] === 'x') {
                i === 0 ? mismatchWave += 'l' : currentMismatch === 'low' ? mismatchWave += '.' : mismatchWave += 'l'
                currentMismatch = 'low'
            } else if (expectedArr[i] === studentArr[i]) {
                i === 0 ? mismatchWave += 'l' : currentMismatch === 'low' ? mismatchWave += '.' : mismatchWave += 'l'
                currentMismatch = 'low'
            } else {
                i === 0 ? mismatchWave += 'h' : currentMismatch === 'high' ? mismatchWave += '.' : mismatchWave += 'h'
                currentMismatch = 'high'
            }
        }

        return mismatchWave
    }
</script>